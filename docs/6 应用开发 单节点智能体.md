# 单节点智能体开发示例

## 概述

Chat Node 是一个集成了大语言模型（LLM）和函数调用（Function Call）功能的节点组件，支持在线和离线模型调用。其接口严格遵循 OpenAI Chat Completion API 规范。

## 开发步骤

### 1. 注册工具

在使用 Chat Node 之前，需要先注册所需的工具。工具分为两类：

- **本地工具**：需要提前实现工具类，开发规范请参考 `本地工具开发规范`
- **远程工具**：通过服务器 URL 配置

#### 1.1 注册本地工具

使用 `add_function_call` 方法注册本地工具，工具描述需遵循 OpenAI Function Call 格式：

```c++
#include <tools.h>
#include <web_search.h>

common_tools::tools::add_function_call(search_news_tool,
    R"({"type":"function","function":{"name":"search_news","description":"使用关键词搜索网页，获取最新的，对时间变化敏感的信息，比如天气、新闻，支持按时间范围、国家等过滤条件获取网页内容、标题和链接信息","parameters":{"type":"object","properties":{"query":{"type":"string","description":"搜索查询字符串，用于在网络上搜索相关信息。关键词组合应简洁明了，避免冗余信息，同时确保能够准确反映用户问题的核心需求。关键词组合应符合搜索引擎的语法和逻辑规则","minLength":1},"time_range":{"type":"string","description":"时间范围，用于限定搜索结果来自的时间","enum":["day","week"]},"country":{"type":"string","description":"地区名称(必须是英文)，用于限定搜索结果来自的地区","enum":["china","usa","japan","..."]}},"required":["query"]}}})"
);
```

工具描述 JSON 格式示例：

```json
[
  {
    "type": "function",
    "function": {
      "name": "search_news",
      "description": "搜索最新新闻信息",
      "parameters": {
        "type": "object",
        "properties": {
          "query": {
            "type": "string",
            "description": "搜索关键词"
          }
        },
        "required": ["query"]
      }
    }
  }
]
```

#### 1.2 注册远程工具服务器

使用 `add_server` 方法注册远程工具服务器：

```c++
#include <tools.h>

common_tools::tools::add_server(
    R"({"WeatherServer":{"url":"http://18.119.131.41:8006","sse_endpoint":"/sse"}})"
);
```

### 2. 配置 Chat Node

创建 `chat_node_settings` 对象并配置模型参数：

```c++
#include <tools.h>

chat_node::chat_node_settings s_generate;
s_generate.model = "gpt-4.1";           // 模型名称
s_generate.temperature = 0.7;           // 温度参数，控制输出随机性
s_generate.top_p = 0.95;                 // Top-p 采样参数
s_generate.max_tokens = 4096;           // 最大生成 token 数
s_generate.tool_choice = "auto";        // 工具选择策略：auto/none/required
s_generate.tools_json = common_tools::tools::get_all_tools_json();  // 获取所有已注册工具
```

### 3. 创建工作流

#### 3.1 创建 Chat Node 实例

```c++
const auto generate_node = std::make_shared<chat_node::ChatNode<std::string, std::string>>(s_generate);
```

#### 3.2 创建并配置 Flow

```c++
auto f = std::make_shared<nodeflow::Flow>();
f->start(generate_node);  // 设置工作流的起始节点
```

#### 3.3 执行工作流

使用 `runWithInput` 方法执行工作流：

```c++
auto result = f->runWithInput<std::string, std::string>(message);
```

**参数说明：**
- 模板参数 `IN`：输入数据类型
- 模板参数 `OUT`：输出数据类型
- `input`：实际的输入数据

**返回值：**
- 工作流的最终输出结果，类型为 `OUT`

## 完整示例

以下是一个完整的单节点智能体实现示例：

```c++
#include <chat_node.h>
#include <log_util.hpp>
#include <nodeflow.hpp>
#include <tools.h>
#include <web_search.h>
#include <nlohmann/json.hpp>

// 注册本地工具
common_tools::tools::add_function_call(search_news_tool,
    R"({"type":"function","function":{"name":"search_news","description":"使用关键词搜索网页，获取最新的，对时间变化敏感的信息，比如天气、新闻，支持按时间范围、国家等过滤条件获取网页内容、标题和链接信息","parameters":{"type":"object","properties":{"query":{"type":"string","description":"搜索查询字符串，用于在网络上搜索相关信息。关键词组合应简洁明了，避免冗余信息，同时确保能够准确反映用户问题的核心需求。关键词组合应符合搜索引擎的语法和逻辑规则","minLength":1},"time_range":{"type":"string","description":"时间范围，用于限定搜索结果来自的时间","enum":["day","week"]},"country":{"type":"string","description":"地区名称(必须是英文)，用于限定搜索结果来自的地区","enum":["china","usa","japan","..."]}},"required":["query"]}}})"
);

// 注册远程工具服务器
common_tools::tools::add_server(
    R"({"WeatherServer":{"url":"http://18.119.131.41:8006","sse_endpoint":"/sse"}})"
);

std::string call_tool_impl_cpp(const std::string& message)
{
    try
    {
        HYB_LOG_INFO("===== call_tool_impl_cpp BEGIN =====");
    
        // 配置 Chat Node 参数
        chat_node::chat_node_settings s_generate;
        s_generate.model = "gpt-4.1";
        s_generate.temperature = 0.7;
        s_generate.top_p = 0.95;
        s_generate.max_tokens = 4096;
        s_generate.tool_choice = "auto";
        s_generate.tools_json = common_tools::tools::get_all_tools_json();
        
        // 创建 Chat Node 实例
        const auto generate_node = std::make_shared<chat_node::ChatNode<std::string, std::string>>(s_generate);

        // 创建工作流并设置起始节点
        auto f = std::make_shared<nodeflow::Flow>();
        f->start(generate_node);
        
        // 执行工作流
        auto result = f->runWithInput<std::string, std::string>(message);

        return result;
    }
    catch (const std::exception& ex)
    {
        HYB_LOG_ERROR(std::string("call_tool_impl_cpp exception: ") + ex.what());
        return R"({"ok":false,"error":"exception"})";
    }
    catch (...)
    {
        HYB_LOG_ERROR("call_tool_impl_cpp unknown exception");
        return R"({"ok":false,"error":"unknown exception"})";
    }
}

int main()
{
    // 构建输入消息（OpenAI Chat Completion 格式）
    nlohmann::json inputJson = nlohmann::json::array();
    inputJson.push_back({
        {"role", "system"},
        {"content", "you are a helper"}
    });
    inputJson.push_back({
        {"role", "user"},
        {"content", "hello there"}
    });
    
    // 调用智能体并获取响应
    const char* response = call_tool_impl_cpp(inputJson.dump().c_str());
    std::string responseStr(response);
    
    // 响应包含完整的对话历史
    std::cout << responseStr << std::endl;

    return 0;
}
```
